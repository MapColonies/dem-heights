
{{- $chartName := include "heights.name" . -}}
{{- $serviceName := include "service.fullname" . -}}
{{- $releaseName := .Release.Name -}}

upstream heights {
    server {{ $serviceName }}:{{ .Values.env.port }};
}

server {
    listen      {{ .Values.env.targetPort }};
    # the domain name it will serve for
    server_name heights;
    # max upload size, adjust to taste
    keepalive_timeout  500;
    proxy_connect_timeout       600;
    proxy_send_timeout          600;
    send_timeout                600;
    client_max_body_size        5000;
    client_header_timeout       600;
    client_body_timeout         600;
    client_header_buffer_size   12288; # 12K
    large_client_header_buffers 4 12288; # 12K
    fastcgi_read_timeout        300;

    location /liveness {
        access_log  off;
        return 200;
    }

    location / {
        proxy_hide_header Set-Cookie;  # ensures the header will not be passed back to the client
        proxy_ignore_headers Set-Cookie;  # ensures that the header will not automatically disable caching within nginx
        proxy_set_header  Cookie ""; # ensures that a client cannot pass any prior cookies to the webapp and spoil your cache
        # proxy_set_header  X-Sub $jwt_payload_sub;
    }
}
